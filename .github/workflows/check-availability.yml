name: Check Kobo Remote Availability

on:
  schedule:
    # Run daily at 9:00 AM Lisbon time
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  TZ: Europe/Lisbon

permissions:
  issues: write

jobs:
  check-availability:
    runs-on: ubuntu-latest
    steps:
      - name: Check Kobo Remote availability
        id: check
        run: |
          PRODUCT_URL="https://pt.kobobooks.com/products/kobo-remote"

          # Fetch the page
          PAGE_CONTENT=$(curl -s "$PRODUCT_URL")

          # Check if product is available (look for "available":true in JSON)
          if echo "$PAGE_CONTENT" | grep -q '"available":true'; then
            STATUS="AVAILABLE"
            EMOJI="ðŸŸ¢"
            MESSAGE="The Kobo Remote is back in stock! Buy now!"
          else
            STATUS="SOLD_OUT"
            EMOJI="ðŸ”´"
            MESSAGE="Still sold out (Esgotado). Check again tomorrow."
          fi

          # Get current date/time
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M')

          # Write to Job Summary
          echo "## $EMOJI Kobo Remote Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MESSAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Product Page]($PRODUCT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Checked: $CURRENT_TIME (Lisbon)*" >> $GITHUB_STEP_SUMMARY

          # Output for downstream steps
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "url=$PRODUCT_URL" >> $GITHUB_OUTPUT
          echo "time=$CURRENT_TIME" >> $GITHUB_OUTPUT

          # Log to console
          echo "Kobo Remote is currently: $STATUS"

      - name: Notify via GitHub Issue comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: 1
          body: |
            ${{ steps.check.outputs.emoji }} **Kobo Remote Status: ${{ steps.check.outputs.status }}**

            ${{ steps.check.outputs.message }}

            ðŸ”— [View Product Page](${{ steps.check.outputs.url }})

            _Checked: ${{ steps.check.outputs.time }} (Lisbon)_

name: Check Kobo Remote Availability

on:
  schedule:
    # Run daily at 9:00 AM Lisbon time
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  TZ: Europe/Lisbon

jobs:
  check-availability:
    runs-on: ubuntu-latest
    steps:
      - name: Check Kobo Remote availability
        run: |
          PRODUCT_URL="https://pt.kobobooks.com/products/kobo-remote"

          # Fetch the page
          PAGE_CONTENT=$(curl -s "$PRODUCT_URL")

          # Check if product is available (look for "available":true in JSON)
          if echo "$PAGE_CONTENT" | grep -q '"available":true'; then
            STATUS="AVAILABLE"
            EMOJI="ðŸŸ¢"
            MESSAGE="The Kobo Remote is back in stock! Buy now!"
          else
            STATUS="Sold Out"
            EMOJI="ðŸ”´"
            MESSAGE="Still sold out (Esgotado). Check again tomorrow."
          fi

          # Get current date/time
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M')

          # Write to Job Summary
          echo "## $EMOJI Kobo Remote Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MESSAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Product Page]($PRODUCT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Checked: $CURRENT_TIME (Lisbon)*" >> $GITHUB_STEP_SUMMARY

          # Output status for potential downstream use
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          # Log to console as well
          echo "Kobo Remote is currently: $STATUS"
